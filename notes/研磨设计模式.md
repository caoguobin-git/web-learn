# 研磨设计模式

[TOC]

## 第1章 设计模式基础

### 1.1 设计模式是什么

#### 1.1.1 什么是模式

从字面上理解，模，就是模型、模板的意思；式，就是方式、方法的以西。结合起来，所谓模式就是：可以作为模型或模板的方式或方法。在简单点说就是可以用来作为样板的方式或方法，类似于大家所熟悉的范例。

#### 1.1.2 设计模式的概念

按照上面的理解，设计模式值得就是设计方面的模板，也即设计方面的方式或方法。

>  设计模式：是指在软件开发种，经过验证的，用于解决在特定环境下、重复出现的、特定问题的解决方案。

1. **设计模式是解决方案**

根据上面对设计模式的定义可以看出，归根结底，设计模式就是一些解决方案。

所谓解决方案，就是解决办法，亦即是解决问题的方式或方法。通常所说的方案书，就是把解决方法文档化后形成的文档。

那么，能不能反过来说：解决方案就是设计模式呢？很明显是不行的。为什么呢？因为在解决方案之前还有一些定语，只有满足这些条件的解决方案才能被称为设计模式。

下面九一个个来看。

2. **设计模式是特定问题的解决方案**

为什么要限制设计模式是“特定问题”的解决方案呢？

限制“特定问题”，说明设计模式并不是什么万能灵药，并不是什么问题都能解决，通常一个设计模式仅仅解决某个或某些特定的问题，并不能包治百病。

因此不要迷信设计模式，也不要滥用设计模式，设计模式解决不了那么多问题，它只是解决“特定问题”的解决方案。

3. **设计模式是重复出现的、特定问题的解决方案**

那么为何要这些特定问题是“重复出现的呢”？

只有这些特定问题“重复出现”，那么为这些问题总结解决方案才是有意义的行为。因为只有总结了这些问题的解决方案，当这些问题再次出现的时候，就可以复用这些解决方案，而不用从头来寻求解决办法了。

4. **设计模式适用于解决在特定环境下、重复出现的、特定问题的解决方案**

为什么要限制在“特定环境下”呢？

任何问题的出现都是有场景的，不能脱离环境去讨论对问题的解决办法，因为在不同环境下，就算是相同的问题，解决办法也不一定是一样的。

5. **设计模式是经过验证的，用于解决在特定环境下、重复出现的、特定问题的解决方案，为什么要限制“经过验证的”呢？**

每个人都可以总结一些用于解决在特定环境下、重复出现的、特定问题的解决方案，但并不是每个人总结的解决方案都算得上是设计模式，这些解决方案应该要有足够的应用来验证，并得到大家的认可和公认。只有经过验证的解决方案才算得上是设计模式。

没有得到验证的解决方案，假如也算设计模式而被大家大量复用的话，万一这个方案有问题呢？那么所有应用它的地方都会出错，都应该修改，这种复用还不如不用呢。

6. **为何要强调“在软件开发中”**

原因很简单，因为接下来要讨论的内容，就是软件开发中的设计模式，因此这里限制“在软件开发中”。

> <strong style="color:#31b397">注意：并不能说设计模式是软件行业独有的，事实上，很多行业都有自己的设计模式。</strong>

#### 1.1.3 设计模式的理解

通过上面对设计模式概念的讲述，可以看出，设计模式也并没有什么神奇之处，下面对设计模式再做几点说明，使读者进一步理解它。

* **设计模式是解决某些问题的办法**

要理解和掌握设计模式，其重心就在于对这些方法的理解和掌握，然后进一步深化到这些方法所体现的思想层面上，将设计模式所体现的思考方式进行吸收和消化，融入到自己的思维中。

* **设计模式不是凭空想象出来的，是经验的积累和总结。**

从理论上来说，设计模式并不一定是最优秀的解决方案，有可能存在比设计模式更优秀的解决发难，也就是说设计模式是相对优秀的，没有最优，只有更优。

> <strong style="color:#31b397">延伸：这也说明，从理论上，我们自己也可以总结一些这样的解决方案，如果能得到大家的认可和验证，也是有可能成为公认的设计模式的。</strong>

* **设计模式并不是一成不变的，而是在不断发展中。**

本书仅仅讨论GoF的著作中所记载的、经典的设计模式，但并不是说只有这些设计模式。因为设计模式的发展从设计模式引入软件中以来，就从来没有停止过。

* **设计模式并不是软件行业独有的，各行各业都有自己的设计模式。**

  用大家身边的例子来说，比如医药行业，就有自己的设计模式。假设一个人感冒了，到要点买感冒药，这个感冒药就是设计模式的一个很好体现。
  
   * 经过验证的：药品上市前，会有大量的验证和试验，以保证药品的安全性。
   * 特定环境下：这些药是针对人的，不是针对其他动物的。
   * 重复出现的：正是因为感冒会重复出现，研制药品才是有意义的。
   * 特定问题：感冒药只是用来解决感冒问题的，不能解决其他问题，比如脚痛。
   * 解决方案：药品本身就是该解决方案的具体体现。
  
  经过上面的比较，你会发现，医药行业对设计模式的体现，一点也不逊色于软件行业。再说设计模式本身不是起源于软件行业，而是起源于建筑业。

#### 1.1.4 设计模式的历史

设计模式起源于建筑行业，一位名叫Alexander的建筑师发现并总结了一些建筑行业的设计模式。

在20世纪90年代，准确的说是1995年，由于Erich Gamma、Richard Helm、Ralph Johnson、John Vlissides合著的《设计模式——可复用面向对象软件的基础》一书的出版，正式掀开了软件行业设计模式的序幕，这本书的思维作者被世人称为四人组，也有人将其称为“四人帮”，也就是大家常见的GoF（Gang of Four）。

### 1.2 设计模式有什么

#### 1.2.1 设计模式的组成

在描述单个设计模式的时候，设计模式通常由以下部分组成。

* **模式名称：**就是为每个设计模式取的名字，好记忆，也好交流。
* **环境和问题：**描述在什么场景下，出现什么样的特定的问题。
* **解决方案：**描述如何解决这个问题。
* **效果：**描述模式应用的效果，以及可能带来的问题，或者使用中需要权衡的问题。

在Java领域，对于设计模式的组成还有另外一种分法，就是按照设计模式所在的技术领域来划分，大致分为以下几类：

* **Java设计模式：**通常指GoF的《设计模式——可复用面向对象软件的基础》一书中提到的设计模式。
* **JavaEE设计模式：**通常指SUN《J2EE核心设计模式》一书中提到的设计模式。
* **其他领域：**包括但不限于：EJB设计模式、实时系统设计模式、多线程设计模式、架构设计模式等。

#### 1.2.2 设计模式的分类

为了缩小范围，我们仅讨论Java设计模式，也就是GoF著作中提到的23个设计模式。对于这23个设计模式，GoF把他们分为三类。

* **创建型模式：**抽象了对象实例化的过程，用来帮助创建对象的实例。
* **结构型模式：**描述如何组合类和对象以获得更大的结构。
* **行为型模式：**描述算法和对象间职责的分配。

当然也有其他方式进行分类的，这里就不再讨论了。

### 1.3 设计模式的学习

#### 1.3.1 为什么要学习设计模式

为什么要学习设计模式？实在是由太多的理由了，这里简单的罗列几点。

1. **设计模式已经成为软件开发人员的“标准词汇”**

很多软件开发人员在相互交流的时候，只是使用设计模式的名称，而不深入说明其具体内容。就如同我们汉语里面使用成语一样，当你在交流中使用一个成语的时候，是不会去讲述这个成语背后的故事的。

举个例子来说：开发人员A碰到了一个问题，然后与开发人员B讨论，开发人员B可能会支招：使用“XX模式”就可以了。如果这个时候开发人员A不懂设计模式，那他们就无法交流。

因此，一个合格的软件开发人员，必须掌握设计模式这个“标准词汇”。

2. **学习设计模式是个人技术能力提高的捷径**

设计模式是很多前辈经验的积累，大都是一些相对优秀的解决方案，很多问题都是典型的、有代表性的问题。

学习设计模式，可以学习到众多前辈的经验，吸收和领会他们的设计思想，掌握他们解决问题的方法，就相当于站在这些巨人的肩膀上，可以让我们个人的技术能力得到快速的提升。学习设计模式虽然有一定的困难，但绝对是快速提高个人技术能力的捷径。

3. **不用重复发明轮子**

设计模式是解决某些特定问题的解决方案。当我们再次面对这些问题的时候，就不用自己从头来解决这些问题，复用这些方案即可。

在大多数情况下，这或许是比自己从头来解决这些问题更好的方案。一是你未必能找到比设计模式更优秀的解决方案；另外，通过使用设计模式可以节省大量的时间，你可以把节省的时间花在其他更需要解决的问题上。

#### 1.3.2 学习设计模式的层次

学习设计模式大致有以下三个层次。

1. **基本入门级**

要求能够正确理解和掌握每个设计模式的基本知识，能够识别在什么场景下、出现了什么样的问题、采用何种方案来解决它，并能够在实际的程序设计和开发中套用相应的设计模式。

2. **基本掌握级**

除了具备基本入门级的要求外，还要求能够解和实际应用的场景，对设计模式进行变形使用。

事实上，在实际开发中，经常会碰到与标准模式的应用场景有一些不一样的情况，此时要合理地使用设计模式，就需要对它们做适当地变形，而不是僵硬地套用了。当然进行变形的前提是要能准确深入地理解和把握设计模式地本质，万变不离其宗，只有把握住本质，才能够确保正确变形使用而不是误用。

3. **深入理解和掌握级**

除了具备基本掌握级的要求外，更主要的是:

在复杂的应用中，当解决某个问题的时候，很可能不是单一应用某一个设计模式，而是综合应用很多设计模式。例如，结合某个具体的情况，可能需要把模式A进行简化，然后结合模式B的一部分，在组合应用变形的模式C...如此来解决问题。

更复杂的是除了考虑这些设计模式外，还可能需要考虑系统整体的体系结构、实际功能的实现、与已有功能的结合等。这就要求在应用设计模式的时候，不拘泥于设计模式本身，而是从思想和方法的层面进行应用。

> <strong style="color:#31b397">延伸：要从思想上和方法上吸收设计模式的精髓，并融入到自己的思路中，在进行软件的分析和设计的时候，能随意的、自然而然地应用，就如同自己思维地一部分。</strong>

简单点说，基本入门级就是套用使用，相当于能够依葫芦画瓢，很机械；基本掌握级就是能变形使用，比基本入门级灵活一些，可以适当变形使用；深入理解和掌握级才算是将设计模式的精髓吸收了，是从思想和方法的层面去理解和掌握设计模式，就犹如练习武功到最高境界，“无招胜有招”了。要想达到这个境界，没有足够的开发和设计经验，没有足够深入的思考，是不太可能达到的。

> <strong style="color:#31b397">提示：有些朋友说：设计模式的书我看了不少，觉得都看懂了，就是不知道在实际开发中怎么用这些设计模式，于是他们认为设计模式是“看上去很美”的“花拳绣腿” 。其实这些朋友正处于“设计模式了解级”，根本还没有入门。</strong>

#### 1.3.3 如何学习设计模式

结合作者自身的经验，给出以下学习设计模式的建议。

1. **首先要调整好心态，不要指望一蹴而就，不可浮躁。**

学习和掌握设计模式需要一个过程，不同的阶段看这些设计模式会有不同的领悟和感受。

不要指望真正的设计模式的书籍是既简单又有趣的，一看就懂的。那种书籍多是属于科普性质的书籍，只是让你简单了解一下设计模式。这也是为何很多朋友总感觉“懂”设计模式，却不会在实际项目中应用设计模式。那是因为你“懂”的程度不够。



### 1.4 本书的组织方式

#### 1.4.1 本书所讲述的设计模式的提纲

#### 1.4.2 每个设计模式的讲述结构

## 第2章 简单工厂

简单工厂不是一个标准的设计模式，但是它实在是太常用了，简单而又神奇，所以需要好好掌握它，就当是学习设计模式的热身运动吧。

为了保持一致性，我们尽量按照学习其他模式的步骤来学习。

### 2.1 场景问题

大家都知道，在Java应用开发中，要“面向接口编程”。

那么什么是接口？接口有什么作用？接口如何使用？我们一起来回顾一下。

#### 2.1.1 接口回顾

1. **Java中接口的概念**

在Java中接口是一种特殊的抽象类，跟一般的抽象类相比，接口里面的所有方法都是抽象方法，接口里面的所有属性都是常量。也就是说，接口里面只有方法定义而没有任何方法实现。

2. **接口是用来做什么的**

通常用接口来定义实现类的外观，也就是实现类的行为定义，用来约束实现类的行为。接口就相当于一份契约，根据外部应用需要的功能，约定了实现类需要实现的功能，但是具体的实现类除了实现接口约定的功能外，还可以根据需要实现一些其他功能，这是允许的，也就是说实现类的功能包含但不仅限于接口约束的功能。

通过使用接口，可以实现不相关类的相同行为，而不需考虑这些类之间的层次关系，接口就是实现类对外的外观。

3. **接口的思想**

根据接口的作用和用途，浓缩下来，接口的思想就是“封装隔离”。

通常提到的封装是指对数据的封装，但是这里的封装是指“对被隔离体的行为的封装”，或者是“对被隔离体的职责的封装”；而隔离指的是外部调用和内部实现，外部调用只能通过接口进行调用，外部调用是不知道内部具体实现的，也就是说外部调用和内部实现是被接口隔离开的。

4. **使用接口的好处**

由于外部调用和内部实现被接口隔离开了，那么只要接口不变，内部实现的变化就不会影响到外部应用，从而使得系统更灵活，具有更好得扩展性和可维护性，这也就是所谓“接口是系统可插拔性得保证”这句话的意思。

5. **接口和抽象类的选择**

既然接口是一种特殊的抽象类，那么在开发中，何时选用接口？合适选用抽象类呢？

对于它们的选择，在开发中是一个很重要的问题，特别总结两句话给大家：

* **优先选用接口**
* **在既要定义子类的行为，又要为子类提供公共的功能时应选择抽象类**

#### 2.1.2 面向接口编程

面向接口编程是Java编程中的一个重要原则。

在Java程序设计里面，非常讲究层的划分和模块的划分。通常按照三层来划分Java程序，分别是表现层、逻辑层和数据层，它们之间都要通过接口来通信。

在每一层里面，又有很多个小模块，每个小模块对外则是一个整体，所以一个模块对外应提供接口，其他地方需要使用到这个模块的功能时，可以通过此接口来进行调用。这也就是常说的“接口是被其隔离部分的外观”。基本的三层结构如图2.1所示。

![image-20200724181718174](pic\研磨设计模式\image-20200724181718174.png)

在一个层内部的各个模块间的交互要通过接口，如图2.2所示。

图片啊啊啊 啊

各个部分的接口具体应该如何去定义，具体的内容是什么，我们不去深究，那是需要具体问题具体分析的，这里仅学习设计的方法。

上面频频提到“组件”，那么什么是组件呢？

所谓组件：从设计上讲，组件就是能完成一定功能的封装体。小到一个类，大到一个系统，都可以称为组件，因为一个小系统放到更大的系统里面，也就是作为一个组件而已。事实上，从设计的角度看，系统、子系统、模块、组件等说的其实是同一回事情，都是完成一定功能的封装体，只不过是功能多少不同而已。

继续刚才的思路，大家会发现，不管是一层还是一个模块或者一个组件，都是一个被接口隔离的整体，那么下面我们就不去区分他们，统一认为他们都是接口隔离体即可，如图2.3所示。

图片图片啊啊啊啊啊啊啊啊啊啊啊啊

既然在Java中需要面向接口编程，那么在程序中到底如何使用接口，来做到真正的面向接口编程呢？

#### 2.1.3 不同模式的解决方案

回忆一下，以前是如何使用接口的呢，假设由一个接口较Api，然后又一个实现类Impl实现了它，在客户端怎么用这个接口呢？

通常都是在客户端创建一个Impl示例，把它赋值给一个Api接口类型的变量，然后客户端就可以通过这个变量来操作接口的功能了，此时具体的结构图如图2.4所示。

图图u团啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊

用代码来说明会更清楚一些。

1. **首先定义接口Api，示例代码如下：**

~~~java
/**
 *某个接口（通用的、抽象的、非具体的功能）
 */
public interface Api{
    /**
     * 某个具体的功能方法的定义，用test1来演示一下。
     * 这里的功能很简单，把传入的s打印输出即可
     * @param s 任意想要打印输出的字符串
     */
    public void test1(String s);
}
~~~

2. **既然有了接口，自然就要有实现，定义实现Impl，示例代码如下：**

~~~java
/**
 * 对接口的实现
 */
public class Impl implements Api{
    @Override
    public void test1(String s){
        System.out.println("Now in Impl. The input s==" + s);
    }
}
~~~

3. **那么此时的客户端怎么写呢？**

按照Java的知识，接口不能直接使用，需要使用接口的实现类，示例代码如下：

~~~java
/**
 * 客户端：测试使用Api接口
 */
public class Client{
    public static void main(String[] args){
        Api api = new Impl();
        api.test1("哈哈，不要紧张，只是个测试而已！")；
    }
}
~~~

#### 2.1.3 有何问题







<strong style="color:#31b397">注意</strong>